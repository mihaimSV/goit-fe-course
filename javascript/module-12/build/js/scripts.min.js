"use strict";var LOCALSTORAGE=function(e){if(e){return{isActive:"localStorage"in e,get:function(e){try{var r=localStorage.getItem(e);return null===r?void 0:JSON.parse(r)}catch(e){console.error("Get state error: ",e)}},set:function(e,r){try{var t=JSON.stringify(r);localStorage.setItem(e,t)}catch(e){console.error("Set state error: ",e)}},remove:function(e){try{localStorage.removeItem(e)}catch(e){console.error("Remove state error: ",e)}},clear:function(){try{localStorage.clear()}catch(e){console.error("Clear state error: ",e)}}}}}(window),api={baseUrl:"http://api.linkpreview.net/",myKey:"5bb09717109fa9d825897e9782df267d7e97eed9cc5b8",getData:function(e){return fetch(this.baseUrl+"?key="+this.myKey+"&q="+e).then(function(e){if(e.ok)return e.json();throw new Error("Error while fetching "+e.statusText)}).catch(function(e){return console.log(e)})}},rest=function(e){return{inputs:e.querySelectorAll("input"),submitBtn:e.querySelector(".js-submit")}},paternURL=/^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/,paternParam=/\/([\w-]+)[\=\&\?]/,paternHttp=/\/\//,formInputBookmark=document.querySelector(".js-form"),restNewBookmark=rest(formInputBookmark),listWrapper=document.querySelector(".list__wrap"),source=document.querySelector("#bookmarkCart").innerHTML.trim(),template=Handlebars.compile(source),myBookmarks={};if(LOCALSTORAGE.isActive){Object.assign(myBookmarks,LOCALSTORAGE.get("myBookmarks"));var keysBkmk=Object.keys(myBookmarks);if(0<keysBkmk.length){var oldMarkup=keysBkmk.reduce(function(e,r){return e+template({name:myBookmarks[r].name,url:r,descr:myBookmarks[r].descr,img:myBookmarks[r].img})},"");listWrapper.insertAdjacentHTML("afterbegin",oldMarkup)}}function addNewBookmark(e){e.preventDefault();var n=restNewBookmark.inputs[1].value.trim(),r=n.search(paternParam);if(0<r&&(n=n.substring(0,r+1)),!paternURL.test(n))return alert("Некоректная ссылка!!!");if(myBookmarks.hasOwnProperty(n))return alert("Закладка на эту страницу уже существует!");var s={title:paternHttp.test(n)?n.substring(n.search(paternHttp)+2):n,description:n,image:"img/diary.png",url:"",error:""};api.getData(n).then(function(e){Object.assign(s,e);var r=restNewBookmark.inputs[0].value.trim();r.length<1&&(r=s.title);var t=restNewBookmark.inputs[2].value.trim();t.length<1&&(t=s.description);var a=s.image;myBookmarks[n]={name:r,descr:t,img:a},LOCALSTORAGE.set("myBookmarks",myBookmarks);var o=template({name:myBookmarks[n].name,url:n,descr:myBookmarks[n].descr,img:myBookmarks[n].img});listWrapper.insertAdjacentHTML("afterbegin",o)})}function handleDeleteBkmk(e){if("BUTTON"===e.target.nodeName){var r=e.target.closest(".cart"),t=r.querySelector(".cart__href").href;delete myBookmarks[t],LOCALSTORAGE.set("myBookmarks",myBookmarks),r.remove()}}restNewBookmark.submitBtn.addEventListener("click",addNewBookmark),listWrapper.addEventListener("click",handleDeleteBkmk);